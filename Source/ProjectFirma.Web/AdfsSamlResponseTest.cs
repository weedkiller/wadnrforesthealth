using System;
using System.Collections.Generic;
using System.Security;
using System.Security.Cryptography.X509Certificates;
using NUnit.Framework;
using ProjectFirma.Web.Common;

namespace ProjectFirma.Web
{
    [TestFixture]
    public class AdfsSamlResponseTest
    {
        [Test]
        public void TestAdfsSamlResponseDateValidity()
        {
            // 12/18/20 TK & MF -- This test requires the QA cert to be installed on the machine it is running in order to pass.

            //this is a QA response
            var samlXml = @"<samlp:Response ID=""_485aafe5-d0ca-47da-afd7-88cea68a91a7"" Version=""2.0"" IssueInstant=""2020-12-17T17:10:06.523Z"" Destination=""https://wadnrforesthealth.qa.projectfirma.com/Account/ADFSPost"" Consent=""urn:oasis:names:tc:SAML:2.0:consent:unspecified"" xmlns:samlp=""urn:oasis:names:tc:SAML:2.0:protocol""><Issuer xmlns=""urn:oasis:names:tc:SAML:2.0:assertion"">http://ead.sts.wa.gov/adfs/services/trust</Issuer><samlp:Status><samlp:StatusCode Value=""urn:oasis:names:tc:SAML:2.0:status:Success"" /></samlp:Status><EncryptedAssertion xmlns=""urn:oasis:names:tc:SAML:2.0:assertion""><xenc:EncryptedData Type=""http://www.w3.org/2001/04/xmlenc#Element"" xmlns:xenc=""http://www.w3.org/2001/04/xmlenc#""><xenc:EncryptionMethod Algorithm=""http://www.w3.org/2001/04/xmlenc#aes256-cbc"" /><KeyInfo xmlns=""http://www.w3.org/2000/09/xmldsig#""><e:EncryptedKey xmlns:e=""http://www.w3.org/2001/04/xmlenc#""><e:EncryptionMethod Algorithm=""http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p""><DigestMethod Algorithm=""http://www.w3.org/2000/09/xmldsig#sha1"" /></e:EncryptionMethod><KeyInfo><ds:X509Data xmlns:ds=""http://www.w3.org/2000/09/xmldsig#""><ds:X509IssuerSerial><ds:X509IssuerName>CN=qa.sso.foresthealthtracker.dnr.wa.gov, O=Sitka Technology Group LLC, L=Portland, S=Oregon, C=US</ds:X509IssuerName><ds:X509SerialNumber>138600704290387722204466128844790403776</ds:X509SerialNumber></ds:X509IssuerSerial></ds:X509Data></KeyInfo><e:CipherData><e:CipherValue>H+NchIiM+sIrK++ziYszFS1iaUAhw7XU4NTo4nB3IwdntynZuIgb0O5dj4t6+px8LQ1eFwrGY/cBBEDclMac3rUsJFbdjQw7XPgVCZF6K0UDgvy9RWNM0zwK+xTMg5ZQat4e2nblriOUBeKpYjZGsiT5HfHDLkxdtcZVZZbzqrBGsZ1o8NX3KM99TBvoTKDJRfPyBHV/aqgxj91Hp8enoqHZ5YYw/qA/Vvv1ExSm732N/lq2OXwkqp5yNyLjuHI6X2m1UWVOpukeMGR0xKrHxdgeoVAHZRWxi8h5RwOIbAGVecN2Scjn+Dsz3IPzdBnD32lPsD+7wINohb56hf7pAg==</e:CipherValue></e:CipherData></e:EncryptedKey></KeyInfo><xenc:CipherData><xenc:CipherValue>EJ2xusBo6/YAs2pMH905iItHuPD/u3OV9Hbhphcp0guvNHeCBpNziG6Zjr3HpBon5gevWJLCaPCF1+4LjIbyxxXn+ZkzzFEXcKzgpP2aog90H3PAB6ISiVWvO5XkmbyRMIpLgAbhR8e6J0KlW4I87m+bMf4YkCdWQLoct7L+XIl19kH3iSu7sZFAkmvZqe602NjaRNs2B5NrGurakxLhrJpZnVvAIzxo8IFz0+H1r9IKwbbmPE60e/v9AO4wpKJoBZe6W4oDygRu+N1W9FfIKDdp/hB9IyUYb6Vg7zMzzhQ/vD0OrrUHyq22XpwXhW4ZlEXKsf24oha5FWvscBYOwrw9ry0eCqXVP4vdfOzYUHEQYap9GieBUqlEuxTnRSF3vFq5fYxbDtLASZTxzvJjv+y3SLGJitn18wk2zS5oreA95O2ifTj28YpTnxWxKuaLwbKijUFYPz+F1MuIM97izCrh/gDs0vf4aOi7Ns6WZxD+PixXwFoF5opnTXltInYg/znbqRLlH5xK4eNvOuHjXD/FfRyIUst7cFrBiod+d7sjlwURhDCHv+HwimF1vWAl0OsXs/lobJb21nt2t9z/M7cTcGsTBK55Ys2fjBK9MJ3qqSV9K3km91v3Uvc+3CqAJfQQRExO4M7z7wLPOC/0G79Oi9a4+7QB4U+yc2tZ+JUz07kULisGlK6YEUfoVgSkK/4gxVfsOyHUY7jRyHIYbALUsZLEWyHeNCyr6/f25hkPXC+CRbtEnfumEFxVfc9JHIE2w4X7ZNJ4or7+awc1ewahOfVBXtLqUTFbIj9lBOsBOY+fARdjdoHpsHisEkmaf5N/IOIENgrTtk0BjanTiiESgz6uINST1QMhfd9295HY6hXUMJ5DfKPSFe0D1SQ10Nko99O+L0W7zyjJSBPgz+GVr7qk2ykqoghxDhjEA96kAJo67jsJFwmR5VvVmzL/AHMabOBgj4AdqFF2wo0571Q1KUt7Z6AZ4QrPKZB63fEwun2oKWuQuhyLwYpJIddlIqYQAYibsMVoPA5o0AsKvhiiLkWG5Fn8JI8qLiRBvVQOT1qGUppo+ZMAra40t4iOx025YKChaWg1g4dyyy+YSrEer6iIN2ujgjoIdsogQfWDZE7T0PSR9WF/eNf3YLbc4+y9AcqMv1A4vPiM+vkHhmbKlRp+ZCaWgWrnilpiAf0r8/EzvmEkOk9+fwkoHio/fhHeD4JGRzFTyGFgBklHuoFPi0/ap101CfBpHeWkrH5XtIBrueqpBk/089oprEBZDAuuyI+562G82S/nYTjMEpKXKpE3u80AoQj+s8X4CKk+v9XkBxJzoTVxkt0L4F/SXI4owGfLLVVXgP9XrOBqcgNH5v2n97UAI6G3ikCujFstCZiN1K78EJ+gy/kqeWAaf+NWsCzZymdB3y2iSqQTk0dkyt5YHbDVhb7nvA0rx6nupoZ+M6Vmdd7oRt0DuFYaEEuJrdk5ow67hkaP95rw0TBqGom3dO8kIf2w/gY0rvfS4M8dCVtyBJMfVKhDTzL0eIvMlC+EAr6ZPg1Ol6wk2sryl2kPU0inIojnbksWqYAI7XfVZ0CXC/4AdixwcsK9QPPTiqy4RNiU/j9BL4XeJPaDCI5i8FRrLpM/E7rIq5bTE73q4sZfszvsgQ7xynCu1Cr5P5SFQHstlDmF8GLTM8U2J6h0y4xk71+UwjlsTRH3mWUJlcbbbS6In5Tk/cB0WPH46rN3WZVLhTG7pMV5H7yCQbVIuh1l0VPn0NxI7Yav1CWR0FlwXYeiAt10GrEr0LGZsdINC5F5iaqNmxQ+UEwdJn2X7spJnGP6S815TLrNd6roKBWd9h/i5dV1Y3XKedS5EeDRVORCEDUjAjoWGZBgHrD0wcnnmbCpWQaxnF92DJcljO86/3UyollJrgqupjhIEuWA0ikLFL/l96Jdg2pgG5M3nu88savAHHMJUizUE3tqf0KdhHatbcwD135Pel9hRAJtdpHjY7EqGGl8F/wHgJYTjOhjuPv+W2FZhf1MPdxR29GZEl1cp4bL0CU7HV5vXcVefM12TSeZOZpNttpXHRlmmQq3rd3/cf9a6VPrX8JF26mK8A8Lkx5hq1s+dS2cSw+Zp3mY+HO9BfpA4/gHn3hQ/HXEQtdSMrIssN2QCnApW4DdooMkDOxq07RRUn5yMbHYaJ8Y5rTHNINyai6VpMaQuH64fDbnv3+LzZ6BmFhvC8pKcjCqj1r115KOdQliKggkcP731XFhoZir4243SoKFIKXfx5Xoe5BPZcHuIxld/0JFX3emjwjKefFughNb9Tro9P/RJVyMwiQFqH52aGc7uBIBJBnT8GGy8slfJ0qerwZuWBVIrqm91WEIagKYd7Lz/77kqxWN6f06yE0gJoJLXJYkPHwfeMTguFdVYJS6Sri/g5zSaciUpasVXy6qVdF1mGvEP9JPHdcWKdsbjUtfMux9L0NJx0Qs98Q24zebMkglnskI5qsiIsUSIkuKSwwSKRxsvTZekGa8oa3Z9Tu/PosGmZXIZUyOHsOPjXig7c1j/8abh9hNnbk0BDnyfi34o2Tad/JjT8K883WIj9+laQrUKkxwu0tPi+sX8UbkwiH3+11d5DSiw8/peIpNyDHvkpU/mOIvI70ycHHOtRc1NPL0W2KgQdr5q44ipesXwY833l9yV75g5KK2etagFy00Vj4qHaItM6kJvC1uI5kEa7AjCoy3WLZDVigM11Qfuy/Q2hKSQdypSgDTdSWdTMv7YLfHizuvvmGdb647n6pBnODpBYs05A07Clot1reb32kcjs6ln/WRMYohEPPJ5sAUVjgYJHGMU9gVEfCgsmURWw1gkSlKYrgPFMmWS3bnl+zuphwwlytkNSXWAIFczAi1VEGspLtU84HR8w5sGPZS/WTdXHW52iccanHJYONZ6w8K+Gj8mdmESMCKDvyE3EpfeI2H+s8BOGDkVNLThi2pUZUXSbyF0U+nsIcSF6nZo9/shOWdenNsxpB7S90Ga3TjdKdkYdN1iUNYVHYhEvuuly1Gii002gzVvf9o0ncVRB2EX0d2zxKnRw0NHzphMDwI51dAAoCn2nkuEArfgS7qjeJjfmGxYDupIL6zJwpoAcPwwJDxVg7pb+X6funUmFaRQZfA1HobPdS3RoL9wLcRo0tvYVbFLi8VtOZ5TzWBsdCz2hlPwE/5fklYSb7YHLcfVM3DiF4O0/BUqMdnrakmK4e7wxbvOcrrMZpfroiYxsuhuIS8DH5D0zwjz0FbigaAxSl0/hrzCiuJKoAe19aTJPbxG4WKEgnbllL0P8MKXidRM6CGXCYLYdyeNjn6kUOwj7gL3ayZKr9H5XDhKEAwZGbeMfWb4cXMY1P0lZ/w1ke/CXHhedVrO6KD8QJSawauOS1gQg68BnT+rstv6D3wFrnYKeUm2HOiZFH+HTHzOWh7lUjVBOO4WyMNWj96viA4XQedCLangC/vuv1CVK3iGLOYnflBUI813J0a0qozq1NLnqKGrAF/y1ELMixpZSuyymGkD2w+A3e1qzq1wQhzy7cbqhsZRmdCFsbNg67paWEj9C+FAH6zw2i/+PEHgK0P6mHnKoLg07wFitNJiPnUuvR/fIDWRG+dL3NHRZn6SLVOxpHEuZ0ENAf4YX7WRQc9UgFbriSMUdYlw7Yv+D/raRSPepV8nlfBMykw3Feo+L20K52KQA9XvZf+nNsBE7yU+6Rvxl+BQF2Zais4nH8AsGNaG9WVaTBfWmByjF0Zk6Ci3i0ek4mFhHEycg/eF6YGIIa7cmQiFgg6CHddxIe/Wgm1/ZXOBMLR/1lhhVPTC8tUEtwn6JG9Wb8m3K5AJb6ihwO63TfVgLwgZBAQ22djpv3ILahHvsdPLUTSsbsRIz+ko5G/4Je2RHeQENN2m2C/S487FNmQLcls+lawSQ+O56D5hwhphPbtwYQ9+DL/e6OZmbgcqahoHhqj4P2s+CnxeViAicZkvsB1CkCF0h4oOQ5sQnxj/aVA+GBtk3Wmc3B/ijzkEoXAQOx0ofbm1sHeoJ1ttNdoP/o+OFkRwtTWMAoNflpayD+BbxVOb9XJjp+9g9z2cv1PpYUC/EqjRsF0X3A8R6mYOZrEWqVaabzW5akaiaPAI5qNGyIIBIObCM7GIrZzObGr3Sa2Bi6aioTIHx6SXGkt1E09evt7pQX/XhRD0osfGnQQVf2uligg7cikc4kvWR8wNE8dWuIctteu9PfhXODtoO8wITdxkf+6P6srEk46cc718mQihjj7Vk9j++eHpSOxo/03IzyB4zpXTXbhvkhR/QReBu5mYJSXf22NxrFzmrcM+RlNXgRSdcTJwCAUKNmJO+MMrNx7ULl4zcX/cHz+fIPTgzJAKbuO4Q/5As+XJHQJIm6npC1aeNNfVaOzlHWLkOaTqW6Uqtvhv+8go0F0rTdsEkTSpLZvrlEgI1g4ZvEFx6ejUa0G2kLnKi2QCQhxjBsXDIqTg7OgINqTYScMJe7+kmictwU4Wqfn0Z29ba8qPrGVZwkaqWi/WxPO7rsZN1nzmemqqWULctYhX1SvODRjCGiM1RdwraFVEOxcxAlZ/7hxU9zJ+2uN7tl2w+QjSeb3tyFFnojldBG4RrZ3XTpBrr4BvmmQtjtGWXPKJFK3ALA+BAKtSD2b/w5hCVMFmaB1+DOEDvkhDterRM1j1DHoMjQwEvDLT0vKFKw+cI/sasdRmlRuekl3j8b/C4yGFjHBL6D6+ljZyc8BjBUN6pvIWd20xVf9Gvu49ZO6yx/OIRfCDH6/P+NunlPeaM3ftqTEjG9KYI2PmunyVD793wRkg/rAh/VwiunRnm2IuZLnq/qWrP3WraSqkbNRrS+jetZE7HSpfh3UQDBQt4DAK0LNftOZXBKkt7XlA0eW3z7qMaEBowQUEr4fDgA3W3XmIJps1vzM7ui+c5esK6/COw8Pb/bpei/GSQO5IMooFPmKokzQY5isIUFxLAEaoQlM18yn4oYwPqqTjAVNrTsnFSh0fmprMj09rKxF4gNwRHe9yVeea2v/fJZmujVV7BQFul5n48jYgMbCRaCY8iZZDCbrUiuMSl8neZiF84LQ4YGFI3Bk0kvyT3wCnAiXo/LjZAU4WYRWqffGcKA/QkSYx8mjdpKW70iTpZHl7a2vbxfm5VrVKIFF1Fz9UA3dQg53P3RG4wL8vGZ11mvDQylCLTvl0zdTD7Lmvi4jcTQ90u6lqvnlvm4VDUTC+p2QFqEetKiyTCNNUZ3xoT03xzE1QTXTDWZvPivUYYonGvPNZldZGQ385Gscnw60LeFj10QksGy/JkzNAMFF901PVc2byn2yJ1AU1VulpWviLmmkCTHxej3tJUrI8OValVaHbgi3tg4HpE/bFGnhCCwVsgI7WbdxUCvnqAF+0Nw/db+WpRD3jzhgMdxZ0qxmKIjv5dhdtqwuITHjtW6VLr+Y44iYZBf3PK2apR3rr8RkrWGHUClQdIwE+2u8pkp8ILWDcNmv6KhecmUHPye5E+H/pzTnafncQ+89gc9CX24Tq5B27wwBkZkcbXOzgWGHhO/NEOOzMNH5tbdyZYANe9l+QTWIhvuZmKTPRasM2m4UM0LQhf2rfZY=</xenc:CipherValue></xenc:CipherData></xenc:EncryptedData></EncryptedAssertion></samlp:Response>";


            var cert = new X509Certificate2("C:\\svn\\sitkatech\\trunk\\WADNRForestHealth\\Build\\SslCertificates\\qa.sso.foresthealthtracker.dnr.wa.gov.password = password.pfx", "password");

            var adfsSamlResponse = new AdfsSamlResponse();
            adfsSamlResponse.LoadFromString(samlXml);
            adfsSamlResponse.Decrypt();

            var firstName = adfsSamlResponse.GetFirstName();
            var lastName = adfsSamlResponse.GetLastName();
            var email = adfsSamlResponse.GetEmail();
            var roleGroups = adfsSamlResponse.GetRoleGroups();

            Assert.That(firstName, Is.EqualTo("Jennifer"));
            Assert.That(lastName, Is.EqualTo("Watkins"));
            Assert.That(email, Is.EqualTo("Jennifer.Watkins@dnr.wa.gov"));
            Assert.That(roleGroups, Is.EquivalentTo(new List<string>(){ "G-S-DNR_WF_ForestHealth_Admin_QA" }));

        }
    }
}